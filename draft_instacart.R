##############################################################################################################

# Draft Instacart Analysis

# Author: Pedro Loes

# Date: 20-11-2021

##############################################################################################################

# Load Libraries

##############################################################################################################

# Carrega pacotes 
library(tidyverse)
library(naniar)
library(arules)
library(gridExtra)
library(knitr)
library(forcats)

##############################################################################################################

# Data Extraction

##############################################################################################################

# Load Instacart data from csv files donwloaded from kaggle
products = read_csv("instacart_data/products.csv")
orders = read_csv("instacart_data/orders.csv")
aisles = read_csv("instacart_data/aisles.csv")
departments = read_csv("instacart_data/departments.csv")
submission = read_csv("instacart_data/sample_submission.csv")
order_products_prior = read_csv("instacart_data/order_products__prior.csv")
order_products_train = read_csv("instacart_data/order_products__train.csv")

##############################################################################################################

# Data Description

##############################################################################################################

# Glimpse tables structures
glimpse(products)
glimpse(orders)
glimpse(aisles)
glimpse(departments)
glimpse(order_products_prior)
glimpse(order_products_train)
glimpse(submission)

# Summarize tables
summary(products)
summary(orders)
summary(aisles)
summary(departments)
summary(order_products_prior)
summary(order_products_train)
summary(submission)

# Define a function to count uniqe values
nunique = function(df){
  
  # Count unique values
  df_nunique = map(df, ~length(unique(.x))) %>% 
    bind_rows() %>% 
    gather(key = col_name, value = unique)
  
  # Define function return
  return(df_nunique)
  
}


# Compute unique values per column
nunique(products)
nunique(orders)
nunique(aisles)
nunique(departments)
nunique(order_products_prior)
nunique(order_products_train)
nunique(submission)

# Scheme of the data base
# ![](data_base_chema.png)

##############################################################################################################

# Verify data quality

##############################################################################################################

# Check for missing data
miss_var_summary(products)
miss_var_summary(orders)
miss_var_summary(aisles)
miss_var_summary(departments)
miss_var_summary(order_products_prior)
miss_var_summary(order_products_train)
miss_var_summary(submission)

# Inspect missing data in orders
gg_miss_var(orders, facet = user_id)
gg_miss_var(order_products_train)
gg_miss_fct(x = orders, fct = user_id)
vis_miss(order_products_train, warn_large_data = F)

##############################################################################################################

# Data exploration

##############################################################################################################

# Retrieve just the order and product columns
train = order_products_train %>% 
          select(order_id, product_id) 

# Count the number of orders grouped by product_id and arrange in decresing order
products_n_orders <- train %>% 
                      group_by(product_id) %>% 
                      summarise(n_orders = n()) %>% 
                      arrange(desc(n_orders)) 

# Center and dispersion statistics from orders
s1 <- summary(products_n_orders$n_orders)
df1 <- tibble(`Estatística` = c("Mínimo","1º Quartil","Mediana","Média",
                        "3º Quartil","Máximo", "Desvio Padrão"),
               Valor = c(s1, sd(products_n_orders$n_orders)))

# Print table
kable(df1)

##############################################################################################################

# Plot number of orders distribution histogram per product
p1 <- ggplot(data = products_n_orders,
             mapping = aes(x = log(n_orders)))+
          geom_histogram(bins = 21, color = "darkgreen", fill = "orange")+
          scale_x_continuous(breaks=c(0, 2.5, 5, 7.5, 10),
                             labels=c(0, 20, 200, 2000, 20000))+
          labs(title = "Distribuição do Número de Vendas por Produto",
               x = "Número de Vendas",
               y = "Frequência")

# Plot number of orders distribution boxplot per product
p2 <- ggplot(data = products_n_orders,
             mapping = aes(x = log(n_orders)))+
          geom_boxplot(color = "darkgreen", fill = "orange")+
          scale_x_continuous(breaks=c(0, 2.5, 5, 7.5, 10),
                             labels=c(0, 20, 200, 2000, 20000))+
          labs(title = "Boxplot do Número de Vendas por Produto",
               x = "Número de Vendas")

# Draw plots
grid.arrange(p1, p2, nrow = 2)

##############################################################################################################

# Count number of products grouped by order_id and arrange in decresing order
orders_n_products <- train %>% 
  group_by(order_id) %>% 
  summarise(n_products = n())

# Center and dispersion statistics from orders
s2 <- summary(orders_n_products$n_products)
df2 <- tibble(`Estatística` = c("Mínimo","1º Quartil","Mediana","Média",
                                "3º Quartil","Máximo", "Desvio Padrão"),
              Valor = c(s2, sd(orders_n_products$n_products)))

# Print table
kable(df2)

##############################################################################################################

# Plot number of products distribution histogram per ordem
p3 <- ggplot(data = orders_n_products,
             mapping = aes(x = n_products))+
  geom_histogram(bins = 40, color = "darkgreen", fill = "orange")+
  labs(title = "Distribuição do Número de Produtos por Ordem",
       x = "Número de Produtos",
       y = "Frequência")

# Plot number of products distribution boxplot per ordem
p4 <- ggplot(data = orders_n_products,
             mapping = aes(x = n_products))+
  geom_boxplot(color = "darkgreen", fill = "orange")+
  labs(title = "Boxplot do Número de Produtos por Ordem",
       x = "Número de Produtos",
       y = "")

# Draw plots
grid.arrange(p3, p4, nrow = 2)

##############################################################################################################

# Define data frame for best products
df_best_products <- products_n_orders %>% 
                      slice(1:20) %>% 
                      left_join(products[, c(1,2)], by = c("product_id" = "product_id")) %>% 
                      arrange(desc(n_orders)) %>% 
                      mutate(product_name = factor(product_name))

# Draw bar plot of 20 of best selling products
ggplot(data = df_best_products,
       mapping = aes(y = reorder(product_name, -n_orders),
                     x = n_orders))+
  geom_col(color = "darkgreen", fill = "orange")+
  labs(title = "20 Produtos Mais Vendidos",
       y = "Produtos",
       x = "Ordens")

##############################################################################################################

# 10 fist observations
order_products_train = read_csv("instacart_data/order_products__train.csv") 
write_csv(order_products_train %>%  slice (1:10), "instacart_data/order_products_train_10.csv")

##############################################################################################################

# Data preparation

##############################################################################################################

# Prepara dados no formato csv
train_names <- train %>%
  left_join(products[, c(1,2)], by = c("product_id" = "product_id")) %>% 
  select(order_id, product_name)
    
# Transform train variables to factor           
train_factor <- train_names %>%
  mutate_if(is.numeric, as.factor) %>% 
  mutate_if(is.character, as.factor)

# Save factor csv
write_csv(train_factor, "instacart_data/train_factor.csv")

# Define transactio  matrix
order_trans <- read.transactions(
  file = "instacart_data/train_factor.csv",
  format = "single",
  sep = ",",
  header = TRUE,
  cols=c("order_id","product_name"),
  rm.duplicates = T
)

# Summarize sparse matrix
summary(order_trans)

##############################################################################################################

# Model arules apriori

##############################################################################################################

# Define rules
rules <- apriori(order_trans, parameter = list(sup = 0.0001, conf = 0.1, target="rules",minlen=1))

# Resume association rules
summary(rules)

# Outputs rules as data frame
rules_output <- as(rules,"data.frame")

##############################################################################################################

# Draw heatmap
plot(rules,method="two-key plot") +
  labs(title = "Dispersão de 123.016 Regras Confiança em Função do Suporte",
       x = "Log(Suporte)",
       y = "Confiança",
       color = "Ordem")+
  scale_x_log10()
  
##############################################################################################################

# Define rules
rules1 <- apriori(order_trans, parameter = list(sup = 0.001, conf = 0.51, target="rules",minlen=1))

# Resume association rules
summary(rules)

# Outputs rules as data frame
rules_output <- as(rules,"data.frame")

##############################################################################################################

# Define rules
rules2 <- apriori(order_trans, parameter = list(sup = 0.000125, conf = 1, target="rules",minlen=1))

# Resume association rules
summary(rules2)

# Outputs rules as data frame
rules_output <- as(rules,"data.frame")

##############################################################################################################

# Define rules
rules3 <- apriori(order_trans, parameter = list(sup = 0.0001, conf = 0.7, target="rules",minlen=1))

# Resume association rules
summary(rules3)

# Outputs rules as data frame
rules_output <- as(rules,"data.frame")

##############################################################################################################

# Rules Vizualization

##############################################################################################################

library(arulesViz)

##############################################################################################################

plot(rules3, method = "graph",  engine = "htmlwidget")

##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################



##############################################################################################################
